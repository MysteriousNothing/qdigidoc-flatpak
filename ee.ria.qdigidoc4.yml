app-id: ee.ria.qdigidoc4
command: run.sh
runtime: org.kde.Platform
runtime-version: '5.14'
sdk: org.kde.Sdk

finish-args:
  # User needs to be able to store & access signed files
  - --filesystem=home
  # Network is needed for some parts of the application's functionality
  - --share=network
  # Wayland
  - --socket=wayland
  # X11
  - --socket=fallback-x11
  - --share=ipc
  # Smartcard
  - --socket=pcsc
  - --device=all
modules:
  - name: xerces-c
    buildsystem: cmake
    sources:
      - type: archive
        url: https://downloads.apache.org//xerces/c/3/sources/xerces-c-3.2.3.tar.gz
        sha256: fb96fc49b1fb892d1e64e53a6ada8accf6f0e6d30ce0937956ec68d39bd72c7e

  - name: xsd
    buildsystem: simple
    build-commands:
      - make
      - make install install_prefix=/app
    sources:
      - type: archive
        url: https://www.codesynthesis.com/download/xsd/4.0/xsd-4.0.0+dep.tar.bz2
        sha256: eca52a9c8f52cdbe2ae4e364e4a909503493a0d51ea388fc6c9734565a859817
      # The Debian repo has many more patches:
      # https://sources.debian.org/src/xsd/4.0.0-8.1/debian/patches/
      - type: patch
        path: xsd/missing-include.patch

  - name: xml-security-c
    buildsystem: autotools
    sources:
      - type: archive
        url: https://downloads.apache.org/santuario/c-library/xml-security-c-2.0.2.tar.gz
        sha256: c303a2b08cb9ca0f5594adcbb83829b1e793175d7114a82f7d78def8bb2e30df

  - name: xxd
    buildsystem: simple
    build-commands:
      - cd src && make installtools prefix=/app
    sources:
      - type: archive
        url: https://github.com/vim/vim/archive/refs/tags/v8.2.2929.tar.gz
        sha256: 55a03cdcf217f9386dc961f5e1384ec7af6fc2746cbcb79ec6c7a6e2d801109b

  - name: libdigidocpp
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/open-eid/libdigidocpp/releases/download/v3.14.6/libdigidocpp-3.14.6.tar.gz
        sha256: cc33312722ff4f7717aea80c4f5e726650a8ce0c8eb799cdadea2db6eba21879

  - name: openldap
    buildsystem: autotools
    config-opts:
      - --disable-backends
      - --disable-overlays
      - --disable-slapd
      - --disable-debug
      - --enable-dynamic
      - --without-threads
      - --with-tls=gnutls
    cleanup:
      - /bin
      - /share/man
    sources:
      - type: archive
        url: https://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-2.5.4.tgz
        sha256: 61c03c078d70cd859e504fa9555d7d52426eed4b29e6a39e828afc213e4fb356
      - type: script
        dest-filename: autogen.sh
        commands:
          - AUTOMAKE=/bin/true autoreconf -vfi

  - name: libusb
    config-opts:
      - --disable-static
      - --disable-udev
    cleanup:
      - /lib/*.la
      - /lib/pkgconfig
      - /include
    sources:
      - type: archive
        url: https://github.com/libusb/libusb/archive/v1.0.24.tar.gz
        sha256: b7724c272dfc5713dce88ff717efd60f021ca5b7c8e30f08ebb2c42d2eea08ae
    post-install:
      - install -Dm644 COPYING /app/share/licenses/libusb/COPYING

  - name: pcsc-lite
    config-opts:
      - --enable-libusb
      - --disable-libudev
      - --disable-libsystemd
      - --without-systemdsystemunitdir
    post-install:
      - rm /app/sbin/pcscd
      - rmdir /app/sbin || true
    cleanup:
      - /lib/libpcscspy.so
      - /lib/libpcsclite.so
    sources:
      - type: archive
        url: https://github.com/LudovicRousseau/PCSC/archive/refs/tags/1.9.1.tar.gz
        sha256: 1eaad042a8a8f9d398bf3fc27a35e516e4f0b90437a0e11a46d280ddd9c5848d

  - name: opensc
    cleanup:
      - /share/applications/org.opensc.notify.desktop
    sources:
      - type: archive
        url: https://github.com/OpenSC/OpenSC/releases/download/0.21.0/opensc-0.21.0.tar.gz
        sha256: 2bfbbb1dcb4b8d8d75685a3e95c30798fb6411d4efab3690fd89d2cb25f3325e

  # This can be called from the browser extension to sign documents
  - name: chrome-token-signing
    buildsystem: qmake
    builddir: true
    subdir: host-linux
    sources:
      - type: archive
        url:  https://github.com/open-eid/chrome-token-signing/archive/refs/tags/v1.1.4.tar.gz
        sha256: 1a7bbde2627461656a4385e19cc771bf137c600f32912b6eb635c05681c4f104
      - type: patch
        path: chrome-token-signing/chrome-token-signing.pro.patch
      - type: patch
        path: chrome-token-signing/native-messaging.patch

  - name: qdigidoc4
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/open-eid/DigiDoc4-Client/releases/download/v4.2.9/qdigidoc4-4.2.9.tar.gz
        sha256: f9afe5a46e67ab4013287efea85ddc5668b8830b4832edde37a15123771d0de6
      - type: patch
        path: qdigidoc4/QPKCS11.patch
      - type: patch
        path: qdigidoc4/client-CMakeLists.patch
      - type: patch
        path: qdigidoc4/qdigidoc4-desktop.patch
        # See guide for building in a sandboxed environment:
        # https://github.com/open-eid/DigiDoc4-Client/wiki/DeveloperTips#building-in-sandboxed-environment
      - type: file
        url: https://ec.europa.eu/tools/lotl/eu-lotl.xml
        sha256: c8a544f078cd6521e14ecbbb11843fa08b755eb198cc2d0f7da3335e4638e942
        dest-filename: client/eu-lotl.xml
      - type: file
        url: https://sr.riik.ee/tsl/estonian-tsl.xml
        sha256: 48d130cd28041b50c472f9887cc82ada945928205bdd841251189382077b76f2
        dest-filename: client/EE.xml
      - type: file
        path: qdigidoc4/TSL.qrc
        dest-filename: client/TSL.qrc
      - type: file
        url: https://id.eesti.ee/config.json
        sha256: ebb9ecd8e578003fc8ca6a83cc38c914dea9a0176158358925a457c5a7a837b9
        dest-filename: common/config.json
      - type: file
        url: https://id.eesti.ee/config.rsa
        sha256: 70d1fa9e343f701950cbb114d89624447f3b5a22a2f294338ca55555d12bbcf7
        dest-filename: common/config.rsa
      - type: file
        url: https://id.eesti.ee/config.pub
        sha256: 29e05778ce98b5197963266bdc292af80a9406cccc3fe5ef7ca2b75b1beb34eb
        dest-filename: common/config.pub
      - type: patch
        path: qdigidoc4/common-CMakeLists.patch
        # qdigidoc4 saves files in $TMPDIR before opening them. Since this is inaccessible, we provide a wrapper script,
        # as advised here: https://docs.flatpak.org/en/latest/sandbox-permissions.html#filesystem-access
      - type: script
        dest-filename: run.sh
        commands:
          - env TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID" qdigidoc4 "$@"
    post-install:
      - install run.sh /app/bin
