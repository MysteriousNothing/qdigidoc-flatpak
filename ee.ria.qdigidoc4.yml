app-id: ee.ria.qdigidoc4
command: run.sh
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
rename-icon: qdigidoc4

finish-args:
  # libdigidocpp stores tsl files here
  - --persist=.digidocpp
  # Network is needed for some parts of the application's functionality
  - --share=network
  # Wayland
  - --socket=wayland
  # X11
  - --socket=fallback-x11
  - --share=ipc
  # Smartcard
  - --socket=pcsc
  - --device=all

cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /etc/bash_completion.d
  - /share/doc
  - /share/man

modules:
  - name: xerces-c
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/apache/xerces-c/archive/refs/tags/v3.2.3.tar.gz
        sha256: a7cf582d618c048ef6a4684457a641940179c446e5f02c81f582f5952755a76a

  - name: xalan-c
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/apache/xalan-c/releases/download/Xalan-C_1_12_0/xalan_c-1.12.tar.gz
        sha256: ee7d4b0b08c5676f5e586c7154d94a5b32b299ac3cbb946e24c4375a25552da7
      - type: patch
        path: xalan-c/CMakeLists.patch
  
  # We use prebuilt xsd since its build seems to take a lot of memory and time. Git history has a
  # non-prebuilt version of the xsd module if needed.
  - name: xsd
    sources:
      - type: archive
        url: https://www.codesynthesis.com/download/xsd/4.0/linux-gnu/x86_64/xsd-4.0.0-x86_64-linux-gnu.tar.bz2
        sha256: d01060cbf4b3a1e462a5c5ad1a5a6773b541766dbbb98e50c9efb8f2a2dd55b7
    buildsystem: simple
    build-commands:
      - install -Dm755 bin/xsd /app/bin/xsd
      - cp -r libxsd/xsd /app/include
      - chmod -R 644 /app/include/xsd

  - name: xml-security-c
    buildsystem: autotools
    config-opts:
      # TODO: we actually do have xalan in the build tree, so we could use it?
      - --with-xalan=no
    sources:
      - type: archive
        url: https://downloads.apache.org/santuario/c-library/xml-security-c-2.0.4.tar.gz
        sha256: a78da6720f6c2ba14100d2426131e0d33eac5a2dba5cc11bdd04974b7eb89003

  - name: xxd
    buildsystem: simple
    build-commands:
      - cd src && make installtools prefix=/app
    cleanup:
      - /share/vim
    sources:
      - type: archive
        url: https://github.com/vim/vim/archive/refs/tags/v8.2.2929.tar.gz
        sha256: 55a03cdcf217f9386dc961f5e1384ec7af6fc2746cbcb79ec6c7a6e2d801109b

  - name: libdigidocpp
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/open-eid/libdigidocpp/releases/download/v3.14.8/libdigidocpp-3.14.8.tar.gz
        sha256: 5398b9200c89178df9f6ae8cea641e984b86efe8a73d8217a8bcbc187bf87648

  - name: openldap
    buildsystem: autotools
    config-opts:
      - --disable-backends
      - --disable-overlays
      - --disable-slapd
      - --disable-debug
      - --enable-dynamic
      - --without-threads
      - --with-tls=gnutls
    cleanup:
      - /bin
      - /share/man
    sources:
      - type: archive
        url: https://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-2.5.4.tgz
        sha256: 61c03c078d70cd859e504fa9555d7d52426eed4b29e6a39e828afc213e4fb356
      - type: script
        dest-filename: autogen.sh
        commands:
          - AUTOMAKE=/bin/true autoreconf -vfi

  - name: libusb
    config-opts:
      - --disable-static
      - --disable-udev
    cleanup:
      - /lib/*.la
      - /lib/pkgconfig
      - /include
    sources:
      - type: archive
        url: https://github.com/libusb/libusb/archive/v1.0.24.tar.gz
        sha256: b7724c272dfc5713dce88ff717efd60f021ca5b7c8e30f08ebb2c42d2eea08ae
    post-install:
      - install -Dm644 COPYING /app/share/licenses/libusb/COPYING

  - name: pcsc-lite
    config-opts:
      - --enable-libusb
      - --disable-libudev
      - --disable-libsystemd
      - --without-systemdsystemunitdir
    post-install:
      - rm /app/sbin/pcscd
      - rmdir /app/sbin || true
    cleanup:
      - /lib/libpcscspy.so
      - /lib/libpcsclite.so
    sources:
      - type: archive
        url: https://github.com/LudovicRousseau/PCSC/archive/refs/tags/1.9.1.tar.gz
        sha256: 1eaad042a8a8f9d398bf3fc27a35e516e4f0b90437a0e11a46d280ddd9c5848d

  - name: opensc
    cleanup:
      - /share/applications/org.opensc.notify.desktop
    sources:
      - type: archive
        url: https://github.com/OpenSC/OpenSC/releases/download/0.21.0/opensc-0.21.0.tar.gz
        sha256: 2bfbbb1dcb4b8d8d75685a3e95c30798fb6411d4efab3690fd89d2cb25f3325e

  # This can be called from the browser extension to sign documents
  - name: chrome-token-signing
    buildsystem: qmake
    builddir: true
    subdir: host-linux
    sources:
      - type: archive
        url:  https://github.com/open-eid/chrome-token-signing/archive/refs/tags/v1.1.5.tar.gz
        sha256: 27fb5ecf0357d134369a714737b23dce94b6e5cc6cb882cde3013c4854bc47f3
      - type: patch
        path: chrome-token-signing/chrome-token-signing.pro.patch
      - type: patch
        path: chrome-token-signing/native-messaging.patch

  - name: qdigidoc4
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/open-eid/DigiDoc4-Client/releases/download/v4.2.11/qdigidoc4_4.2.11.110.orig.tar.xz
        sha256: c21a8d524359d36e6bdd89b77fe0e0554027965a797267962a3cb43f21684d7a
      - type: patch
        path: qdigidoc4/QPKCS11.patch
      - type: patch
        path: qdigidoc4/client-CMakeLists.patch
      - type: file
        path: ee.ria.qdigidoc4.metainfo.xml
      # See guide for building in a sandboxed environment:
      # https://github.com/open-eid/DigiDoc4-Client/wiki/DeveloperTips#building-in-sandboxed-environment
      - type: file
        url: https://ec.europa.eu/tools/lotl/eu-lotl.xml
        sha256: 6d8a4a5d90c787e2c3ee5c89bbc4f0cb83ef65b5ff6535af05b8aa2350dd3005
        dest: client
        dest-filename: eu-lotl.xml
      - type: file
        url: https://sr.riik.ee/tsl/estonian-tsl.xml
        sha256: fd4468149914d20692453a19eecdc70b9e5e4a84485cb298d27a054443337909
        dest: client
        dest-filename: EE.xml
      - type: file
        path: qdigidoc4/TSL.qrc
        dest: client
        dest-filename: TSL.qrc
      - type: file
        url: https://id.eesti.ee/config.json
        sha256: 6d0cb16de0cc3802ec44522e4d593b2937a7b52743c19a3408ce7a9b896e3c6e
        dest: common
        dest-filename: config.json
      - type: file
        url: https://id.eesti.ee/config.rsa
        sha256: 5f2533dc31f729722265560d7fa8aa70784a52a11f002043c8ece622a32b2a44
        dest: common
        dest-filename: config.rsa
      - type: file
        url: https://id.eesti.ee/config.pub
        sha256: 29e05778ce98b5197963266bdc292af80a9406cccc3fe5ef7ca2b75b1beb34eb
        dest: common
        dest-filename: config.pub
      - type: patch
        path: qdigidoc4/common-CMakeLists.patch
      # qdigidoc4 saves files in $TMPDIR before opening them. Since this is inaccessible, we provide a wrapper script,
      # as advised here: https://docs.flatpak.org/en/latest/sandbox-permissions.html#filesystem-access
      - type: script
        dest-filename: run.sh
        commands:
          - env TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID" qdigidoc4 "$@"
    post-install:
      - install run.sh "${FLATPAK_DEST}/bin/run.sh"
      - install -Dm644 ee.ria.qdigidoc4.metainfo.xml $FLATPAK_DEST/share/metainfo/ee.ria.qdigidoc4.metainfo.xml
      - ln -s $FLATPAK_DEST/share/locale/et/LC_MESSAGES/nautilus-qdigidoc.mo $FLATPAK_DEST/share/locale/et/nautilus-qdigidoc.mo
      - ln -s $FLATPAK_DEST/share/locale/ru/LC_MESSAGES/nautilus-qdigidoc.mo $FLATPAK_DEST/share/locale/ru/nautilus-qdigidoc.mo
      - mv $FLATPAK_DEST/share/applications/qdigidoc4.desktop $FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop
      - desktop-file-edit --set-icon=${FLATPAK_ID} --set-key=Exec --set-value="run.sh" /app/share/applications/${FLATPAK_ID}.desktop
      - mv $FLATPAK_DEST/share/mime/packages/qdigidoc4.xml $FLATPAK_DEST/share/mime/packages/$FLATPAK_ID.xml
